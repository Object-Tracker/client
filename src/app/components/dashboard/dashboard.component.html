<div class="h-screen flex flex-col bg-gray-100">
  <!-- Header -->
  <header class="bg-white shadow-sm px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-800">Object Tracker</h1>
    <div class="flex items-center gap-4">
      @if (authService.currentUser(); as user) {
      <span class="text-gray-600">{{ user.username }}</span>
      }
      <button
        (click)="logout()"
        class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-md transition"
      >
        Logout
      </button>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-80 bg-white shadow-lg flex flex-col">
      <!-- Objects Panel -->
      <div class="p-4 border-b">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-semibold text-gray-800">My Objects</h2>
          <button
            (click)="openAddModal()"
            class="px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition"
          >
            + Add
          </button>
        </div>

        <div class="space-y-2 max-h-64 overflow-y-auto">
          @for (obj of objects(); track obj.id) {
          <div
            (click)="selectObject(obj)"
            [class.ring-2]="selectedObject()?.id === obj.id"
            [class.ring-blue-500]="selectedObject()?.id === obj.id"
            class="p-3 rounded-lg border cursor-pointer hover:bg-gray-50 transition"
            [class.bg-red-50]="obj.outsideGeofence"
            [class.border-red-300]="obj.outsideGeofence"
          >
            <div class="flex items-center gap-3">
              <span class="text-2xl">{{ getObjectEmoji(obj) }}</span>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-gray-800 truncate">{{ obj.name }}</p>
                @if (obj.outsideGeofence) {
                <p class="text-xs text-red-600">Outside safe zone!</p>
                } @else if (obj.latitude) {
                <p class="text-xs text-green-600">Inside safe zone</p>
                } @else {
                <p class="text-xs text-gray-400">No location set</p>
                }
              </div>
              <div class="flex gap-1">
                <button
                  (click)="simulateMovement(obj); $event.stopPropagation()"
                  [disabled]="isSimulating()"
                  class="p-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 disabled:opacity-50"
                  title="Simulate movement outside zone"
                >
                  Test
                </button>
                <button
                  (click)="deleteObject(obj); $event.stopPropagation()"
                  class="p-1 text-xs text-red-500 hover:bg-red-100 rounded"
                  title="Delete"
                >
                  X
                </button>
              </div>
            </div>
          </div>
          } @empty {
          <div class="text-center py-6">
            <p class="text-4xl mb-2">üìç</p>
            <p class="text-gray-500 text-sm">No objects yet</p>
            <p class="text-gray-400 text-xs">Click "+ Add" to track something</p>
          </div>
          }
        </div>
      </div>

      <!-- Geofence Settings -->
      <div class="p-4 border-b">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-semibold text-gray-800">Safe Zone</h2>
          <button
            (click)="openGeofenceModal()"
            class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition"
          >
            Configure
          </button>
        </div>
        @if (authService.currentUser()?.geofenceCenterLat) {
        <p class="text-xs text-gray-500">
          Radius: {{ authService.currentUser()?.geofenceRadiusMeters }}m
        </p>
        } @else {
        <p class="text-xs text-gray-500">Not configured</p>
        }
      </div>

      <!-- Simulation Settings -->
      <div class="p-4 border-b">
        <h2 class="font-semibold text-gray-800 mb-2">Simulation Settings</h2>
        <div class="space-y-2">
          <div>
            <label class="block text-xs text-gray-600 mb-1">Speed (ms per step)</label>
            <input
              type="range"
              [(ngModel)]="simulationIntervalMs"
              min="50"
              max="1000"
              step="50"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span class="text-xs text-gray-500">{{ simulationIntervalMs }}ms</span>
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">Step size (meters)</label>
            <input
              type="range"
              [(ngModel)]="simulationStepMeters"
              min="1"
              max="50"
              step="1"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span class="text-xs text-gray-500">{{ simulationStepMeters }}m</span>
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">Total steps</label>
            <input
              type="range"
              [(ngModel)]="simulationTotalSteps"
              min="10"
              max="100"
              step="5"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span class="text-xs text-gray-500">{{ simulationTotalSteps }} steps</span>
          </div>
        </div>
      </div>
      <!-- Notifications -->
      <div class="flex-1 p-4 overflow-y-auto">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-semibold text-gray-800">
            Notifications @if (webSocketService.notificationCount() > 0) {
            <span class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">
              {{ webSocketService.notificationCount() }}
            </span>
            }
          </h2>
          @if (notificationPermission() === 'default') {
          <button
            (click)="enablePushNotifications()"
            class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
          >
            Enable Push
          </button>
          } @else if (notificationPermission() === 'denied') {
          <span class="text-xs text-red-500">Push blocked</span>
          }
        </div>
        <div class="space-y-2">
          @for (notification of notifications(); track $index) {
          <div
            class="p-2 rounded text-sm"
            [class.bg-red-100]="notification.type === 'GEOFENCE_EXIT'"
            [class.bg-green-100]="notification.type === 'GEOFENCE_ENTER'"
          >
            <div class="flex justify-between">
              <span>{{ notification.message }}</span>
              <button (click)="clearNotification($index)" class="text-gray-400 hover:text-gray-600">
                x
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">{{ notification.timestamp | date : 'short' }}</p>
          </div>
          } @empty {
          <p class="text-gray-500 text-xs">No notifications</p>
          }
        </div>
      </div>
    </aside>

    <!-- Map -->
    <main class="flex-1 relative">
      <div id="map" class="w-full h-full"></div>

      @if (selectedObject()) {
      <div class="absolute top-4 left-4 bg-white px-4 py-2 rounded-lg shadow-md">
        <p class="text-sm">
          Click on the map to set location for <strong>{{ selectedObject()?.name }}</strong>
        </p>
        <button
          (click)="selectedObject.set(null)"
          class="mt-2 text-xs text-blue-600 hover:underline"
        >
          Cancel
        </button>
      </div>
      } @if (isSimulating()) {
      <div class="absolute top-4 right-4 bg-yellow-100 px-4 py-2 rounded-lg shadow-md">
        <p class="text-sm text-yellow-800">Simulating movement...</p>
      </div>
      }
    </main>
  </div>

  <!-- Add Object Modal -->
  @if (showAddModal()) {
  <div
    class="fixed inset-0 flex items-center justify-center"
    style="background-color: rgba(0, 0, 0, 0.5); z-index: 9999"
  >
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <h3 class="text-xl font-semibold mb-2 text-center">Add Object to Track</h3>
      <p class="text-gray-500 text-sm text-center mb-4">Select what you want to track</p>

      <!-- Preset Grid -->
      <div class="grid grid-cols-4 gap-2 mb-4">
        @for (preset of objectPresets; track preset.name) {
        <button
          (click)="selectPreset(preset)"
          class="flex flex-col items-center p-3 rounded-lg border-2 transition hover:bg-gray-50"
          [class.border-blue-500]="selectedPreset?.name === preset.name"
          [class.bg-blue-50]="selectedPreset?.name === preset.name"
          [class.border-gray-200]="selectedPreset?.name !== preset.name"
        >
          <span class="text-2xl mb-1">{{ preset.icon }}</span>
          <span class="text-xs text-gray-600">{{ preset.name }}</span>
        </button>
        }
      </div>

      <!-- Custom Name Input -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input
          type="text"
          [(ngModel)]="newObjectName"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., My House Keys"
        />
      </div>

      <!-- Custom Emoji Input -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">Emoji (paste any emoji)</label>
        <input
          type="text"
          [(ngModel)]="newObjectIcon"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl"
          placeholder="üîë"
          maxlength="2"
        />
      </div>

      <!-- Preview -->
      @if (newObjectName && newObjectIcon) {
      <div class="mb-4 p-3 bg-gray-50 rounded-lg flex items-center justify-center gap-3">
        <div
          style="
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          "
        >
          {{ newObjectIcon }}
        </div>
        <span class="font-medium">{{ newObjectName }}</span>
      </div>
      }

      <!-- Buttons -->
      <div class="flex gap-2">
        <button
          (click)="showAddModal.set(false)"
          class="flex-1 px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition"
        >
          Cancel
        </button>
        <button
          (click)="addObject()"
          [disabled]="!newObjectName || !newObjectIcon"
          class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Add Object
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Geofence Modal -->
  @if (showGeofenceModal()) {
  <div
    class="fixed inset-0 flex items-center justify-center"
    style="background-color: rgba(0, 0, 0, 0.5); z-index: 9999"
  >
    <div class="bg-white rounded-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-4">Configure Safe Zone</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Center Latitude</label>
          <input
            type="number"
            [(ngModel)]="geofenceLat"
            step="0.0001"
            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Center Longitude</label>
          <input
            type="number"
            [(ngModel)]="geofenceLng"
            step="0.0001"
            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Radius (meters)</label>
          <input
            type="number"
            [(ngModel)]="geofenceRadius"
            min="50"
            max="10000"
            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <button
          (click)="useCurrentLocation()"
          class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md transition text-sm"
        >
          Use My Current Location
        </button>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button
          (click)="showGeofenceModal.set(false)"
          class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition"
        >
          Cancel
        </button>
        <button
          (click)="saveGeofence()"
          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
        >
          Save
        </button>
      </div>
    </div>
  </div>
  }
</div>
